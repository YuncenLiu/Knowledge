> åˆ›å»ºäº 2021å¹´5æœˆ21æ—¥
>
> ä½œè€…ï¼š[æ•–ä¸™](https://mp.weixin.qq.com/s?__biz=MzAwNDA2OTM1Ng==&mid=2453141985&idx=2&sn=875412f607c18fa6ba6aa0b0862b7fe6&scene=21#wechat_redirect)

[toc]

## ConcurrentHashMapåŸç†

å¤§çº²ï¼š

1. å¤šçº¿ç¨‹ä¸‹ HashMap æœ‰ä»€ä¹ˆé—®é¢˜
2. æ€ä¹ˆä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä¸ºä»€ä¹ˆé€‰ç”¨ ConcurrentHashMap
3. ConcurrentHashMap 1.7 è§£æ
   1. å­˜å‚¨åº•å±‚ç»“æ„
   2. å¸¸ç”¨å˜é‡
   3. æ„é€ å‡½æ•°
   4. putï¼ˆï¼‰æ–¹æ³•
   5. ensureSegmentï¼ˆï¼‰æ–¹æ³•
   6. rehashï¼ˆï¼‰æ‰©å®¹æœºåˆ¶
   7. getï¼ˆï¼‰è·å–å…ƒç´ æ–¹æ³•
   8. removeï¼ˆï¼‰æ–¹æ³•
   9. sizeï¼ˆï¼‰æ–¹æ³•å¦‚ä½•ç»Ÿè®¡å…ƒç´ ä¸ªæ•°çš„
4. ConcurrentHashMap 1.8 è§£æ
   1. putï¼ˆï¼‰æ–¹æ³•è§£æ
   2. initTableï¼ˆï¼‰åˆå§‹åŒ–è¡¨
   3. addCountï¼ˆï¼‰æ–¹æ³•
   4. fullAddCountï¼ˆï¼‰æ–¹æ³•
   5. transferï¼ˆï¼‰æ˜¯æ€ä¹ˆæ‰©å®¹å’Œè¿ç§»å…ƒç´ çš„



åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œå·²ç»è®²è§£äº† HashMap 1.7 æ­»å¾ªç¯çš„æˆå› ï¼Œä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œæˆ‘ä»¬æ‰è¯´ HashMap åœ¨å¤šçº¿ç¨‹ä¸‹æ˜¯ä¸å®‰å…¨çš„ã€‚ä½†æ˜¯ï¼Œåœ¨JDK1.8 çš„ HashMap æ”¹ä¸ºé‡‡ç”¨å°¾æ’æ³•ï¼Œå·²ç»ä¸å­˜åœ¨æ­»å¾ªç¯çš„é—®é¢˜äº†ï¼Œä¸ºä»€ä¹ˆä¹Ÿä¼šçº¿ç¨‹ä¸å®‰å…¨å‘¢ï¼Ÿ



### 1ã€ä¸ºä»€ä¹ˆé€‰ç”¨ ConcurrentHashMap

â€‹	é¦–å…ˆæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®‰å…¨çš„Mapæœ‰ Hashtableï¼Œæˆ‘ä»¬çœ‹ä¸‹ HashTable çš„getæ–¹æ³•å’Œputæ–¹æ³•ï¼Œå¯ä»¥å‘ç°ï¼Œéƒ½æ˜¯åœ¨æ–¹æ³•å¤´ä¸ŠåŠ äº† synchronizd å…³é”®å­—ï¼Œå½“æœ‰å¤šä¸ªå…ƒç´ ä¹‹å‰å­˜åœ¨èµ„æºç«äº‰æ—¶ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è·å–åˆ°é”ï¼Œæ“ä½œèµ„æºã€‚æ›´ä¸èƒ½å¿çš„æ˜¯ï¼Œä¸€ä¸ªç®€å•çš„è¯»å–æ“ä½œï¼Œäº’ç›¸ä¹‹é—´åˆä¸å½±å“ï¼Œä¸ºä»€ä¹ˆä¹Ÿä¸èƒ½åŒæ—¶è¿›è¡Œå‘¢ï¼Ÿ

â€‹	æ‰€ä»¥ï¼Œhashtableçš„ç¼ºç‚¹æ˜¾è€Œæ˜“è§ï¼Œå®ƒä¸ç®¡æ˜¯getè¿˜æ˜¯putæ“ä½œï¼Œéƒ½æ˜¯é”ä½äº†æ•´ä¸ª table æ•ˆç‡ä½ä¸‹ï¼Œå› æ­¤å¹¶ä¸æ”¯æŒé«˜å¹¶å‘åœºæ™¯

â€‹	é™¤äº† hashTable è¿˜æœ‰ SynchronizedMapï¼Œå…¶å®ï¼Œä»–å’Œ Hashtaleå·®ä¸å¤šåŸå› ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½åŠ äº† synchronizedï¼Œæ•ˆç‡ä½ä¸‹



â€‹	æ‰€ä»¥ï¼Œæ€è€ƒä¸€ä¸‹ï¼Œæ—¢ç„¶é”ä½äº†æ•´å¼ è¡¨çš„è¯ï¼Œå¹¶å‘æ•ˆç‡ä½ï¼Œé‚£æˆ‘ä»¬æŠŠæ•´å¼ è¡¨åˆ†æˆNä¸ªéƒ¨åˆ†ï¼Œå¹¶ä½¿ç”¨å…ƒç´ å°½é‡å‡åŒ€çš„åˆ†å¸ƒåˆ°æ¯ä¸ªéƒ¨åˆ†ä¸­ï¼Œåˆ†åˆ«ç»™ä»–ä»¬åŠ é”ï¼Œäº’ç›¸ä¹‹é—´å¹¶ä¸å½±å“ï¼Œè¿™ç§æ–¹å¼å²‚ä¸æ˜¯æ›´å¥½ã€‚è¿™å°±æ˜¯ JDK1.7ä¸­çš„ ConcurentHashMapçš„é‡‡ç”¨æ–¹æ³•ï¼Œè¢«å«åšé”åˆ†æ®µé”æŠ€æœ¯ï¼Œæ¯ä¸ªéƒ¨åˆ†å°±æ˜¯ä¸€ä¸ª Segmentï¼ˆæ¡¶ï¼‰ğŸª£

â€‹	ä½†æ˜¯ï¼Œåœ¨JDK1.8ä¸­ï¼Œå®Œå…¨é‡æ„äº†ï¼Œé‡‡ç”¨ synchronized+CAS å§é”çš„åŠ›åº¦è¿›æ­¥ä¸€é™ä½äº†ï¼Œè€Œæ”¾å¼ƒäº† segment åˆ†æ®µã€‚ï¼ˆ1.8çš„ synchronizedå·²ç»å‡çº§äº†ï¼Œæ•ˆç‡å¾—åˆ°äº†æå¤§çš„æå‡ï¼‰é”å‡çº§



#### 1.1ã€ConcurrentHashMap 1.7æºç è§£æ

> å¼ºçƒˆå»ºè®®ï¼šå‰æéœ€è¦äº†è§£->
>
> + å¤šçº¿ç¨‹çŸ¥è¯†
> + JMMå†…å­˜æ¨¡å‹
> + volatileå…³é”®å­—ä½œç”¨
> + CASå’Œè‡ªæ—‹
> + ReentranLocké‡å…¥é”

