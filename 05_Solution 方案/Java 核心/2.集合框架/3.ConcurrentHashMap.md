> æœ¬æ–‡åˆ›å»ºäº 2021-5-12
>
> ä½œè€…ï¼š[æ•–ä¸™](https://mp.weixin.qq.com/s?__biz=MzAwNDA2OTM1Ng==&mid=2453141162&idx=1&sn=72976d5ae28ca6e7cdeaef407d3fe2ca&scene=21#wechat_redirect)

[toc]

## ConcurrentHashMap

### 1ã€å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å¦‚ä½•ä½¿ç”¨HashMap

+ ä½¿ç”¨ Collections.synchronizedMap(Map)åˆ›å»ºçº¿ç¨‹å®‰å…¨çš„mapé›†åˆ
+ Hashtable
+ ConcurrentHashMap

å‡ºäºç¨‹åºå¹¶å‘åŸå› ï¼Œä¸€èˆ¬éƒ½æ˜¯èˆå¼ƒå‰ä¸¤ç§ä½¿ç”¨æœ€åçš„ ConcurrentHashMapï¼Œä»–çš„æ€§èƒ½å’Œæ•ˆç‡æ˜æ˜¾é«˜äºå‰ä¸¤è€…

#### 1ã€Collections.synchronizedMap æ˜¯æ€ä¹ˆå®ç°çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ

åœ¨SynchronizedMapå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªæ™®é€šMapï¼Œè¿˜æœ‰æ’æ–¥é” mutex

![image-20210512093859744](images/image-20210512093859744.png)

æˆ‘ä»¬åœ¨è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„æ—¶å€™éœ€è¦ä¼ å…¥ä¸€ä¸ª Mapï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸¤ä¸ªæ„é€ å™¨ï¼Œå¦‚æœä½ ä¼ å…¥äº† mutexå‚æ•°ï¼Œåˆ™å°†å¯¹è±¡æ’æ–¥é”èµ‹å€¼ä¸ºä¼ å…¥çš„å¯¹è±¡ã€‚

å¦‚æœæ²¡æœ‰ï¼Œåˆ™å°†å¯¹è±¡æ’æ–¥é”èµ‹å€¼ä¸ºthisï¼Œå³è°ƒç”¨ synchronizedMap çš„å¯¹è±¡ï¼Œå°±æ˜¯ä¸Šé¢çš„ Mapã€‚

åˆ›å»ºå‡º synchronizedMap ä¹‹åï¼Œå†æ“ä½œ map çš„æ—¶å€™ï¼Œå°±ä¼šå¯¹æ–¹æ³•ä¸Šé”ã€‚å¦‚å›¾ï¼Œå…¨æ˜¯é”ğŸ”’

![image-20210512094204113](images/image-20210512094204113.png)#### 2ã€Hashtableï¼Ÿ

è·ŸHashMap ç›¸æ¯” Hashtable æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé€‚åˆåœ¨å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ä½¿ç”¨ã€‚ä½†æ˜¯æ•ˆç‡å¯ä¸å¤ªä¹è§‚ã€‚

![image-20210512094307236](images/image-20210512094307236.png)

Hashtable æ˜¯ä¸å…è®¸é”®æˆ–å€¼ä¸º null çš„ï¼ŒHashMap çš„é”®å€¼å¯¹åˆ™éƒ½å¯ä»¥ä¸ºnullï¼ŒHashtable åœ¨æˆ‘ä»¬putç©ºå€¼çš„æ—¶å€™ç›´æ¥æŠ›å‡ºç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œä½†æ˜¯HashMap å´åšäº†ç‰¹æ®Šå¤„ç†

```java
static final int hash(Object key) {
    int h;
    return (key == null) ? 0 : (h = key.hashCode()) ^ (h >>> 16);
}
```

#### 3ã€ä¸ºä»€ä¹ˆä¸å…è®¸ Hashtable çš„é”®æˆ–å€¼ä¸ºnullçš„ï¼Ÿ

è¿™æ˜¯å› ä¸º hashtable ä½¿ç”¨çš„æ˜¯ å®‰å…¨å¤±è´¥æœºåˆ¶ï¼ˆfail-safeï¼‰ï¼Œè¿™ç§æœºåˆ¶ä¼šä½¿ä½ æ­¤æ¬¡è¯»åˆ°çš„æ•°æ®ä¸ä¸€å®šæ˜¯æœ€æ–°çš„æ•°æ®ã€‚

å¦‚æœä½ ä½¿ç”¨nullå€¼ï¼Œå°±ä¼šä½¿å¾—æ— æ³•åˆ¤å¯¹åº”çš„keyæ˜¯ä¸æ˜¯å­˜åœ¨è¿˜æ˜¯ä¸ºç©ºï¼Œå› ä¸ºä½ æ— æ³•å†è°ƒç”¨ä¸€æ¬¡ containï¼ˆkeyï¼‰å¯¹äºkeyæ˜¯å¦å­˜åœ¨è¿›è¡Œåˆ¤æ–­ï¼ŒConcurrentHashMapåŒç†ã€‚

**ä¸åŒç‚¹**

+ å®ç°æ–¹æ³•ä¸åŒï¼šHashtbale ç»§æ‰¿äº† Dictionary ç±»ï¼Œè€Œ HashMap ç»§æ‰¿çš„æ˜¯ AbstracMapç±»
  + Dictionary æ˜¯ JDK1.0 æ·»åŠ çš„ï¼Œè²Œä¼¼æ²¡äººç”¨è¿‡
+ åˆå§‹åŒ–å®¹é‡ä¸åŒï¼šHashMap çš„åˆå§‹åŒ–å®¹é‡ä¸º 16ï¼ŒHashtable åˆå§‹åŒ–å®¹é‡ä¸º 11ï¼Œä¸¤ä¸ªè´Ÿè½½å› å­é»˜è®¤éƒ½æ˜¯ 0.75
+ æ‰©å®¹æœºåˆ¶ä¸åŒï¼šå½“ç°æœ‰å®¹é‡ > æ€»å®¹é‡ âœ–ï¸ è´Ÿè½½å› å­æ—¶ï¼ŒHashMap æ‰©å®¹è§„åˆ™ä¸ºå½“å‰å®¹é‡ç¿»å€ï¼ŒHashtable æ‰©å®¹è§„åˆ™ä¸ºå½“å‰å®¹é‡ç¿»å€ + 1ã€‚
+ è¿­ä»£å™¨ä¸åŒï¼šHashMap ä¸­çš„ Iterator è¿­ä»£å™¨æ˜¯ fail-fast çš„ã€‚è€Œ Hashtable çš„ Enumerator ä¸æ˜¯ fail-fast çš„ã€‚

æ‰€ä»¥ï¼Œå½“å…¶ä»–çº¿ç¨‹æ”¹å˜äº† HashMap çš„æœºæ„æ—¶å€™ï¼Œå¦‚ï¼šå¢åŠ ã€åˆ é™¤å…ƒç´ ã€‚å°†ä¼šæŠ›å‡º ConcurrentModificationException å¼‚å¸¸ï¼Œè€ŒHashtable ä¸ä¼šã€‚

```http
fail-fastå’Œfail-safeçš„åŒºåˆ«ï¼š
fail-safeå…è®¸åœ¨éå†çš„è¿‡ç¨‹ä¸­å¯¹å®¹å™¨ä¸­çš„æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œè€Œfail-faståˆ™ä¸å…è®¸
fail-fast:ç›´æ¥åœ¨å®¹å™¨ä¸Šè¿›è¡Œéå†ï¼Œåœ¨éå†è¿‡ç¨‹ä¸­ï¼Œä¸€æ—¦å‘ç°å®¹å™¨ä¸­çš„æ•°æ®è¢«ä¿®æ”¹äº†ï¼Œä¼šç«‹åˆ»æŠ›å‡ºConcurrentModificationExceptionå¼‚å¸¸å¯¼è‡´éå†å¤±è´¥ã€‚java.utilåŒ…ä¸‹çš„é›†åˆç±»éƒ½æ˜¯å¿«é€Ÿå¤±è´¥æœºåˆ¶çš„, å¸¸è§çš„çš„ä½¿ç”¨fail-fastæ–¹å¼éå†çš„å®¹å™¨æœ‰HashMapå’ŒArrayListç­‰ã€‚
fail-safe:è¿™ç§éå†åŸºäºå®¹å™¨çš„ä¸€ä¸ªå…‹éš†ã€‚å› æ­¤ï¼Œå¯¹å®¹å™¨å†…å®¹çš„ä¿®æ”¹ä¸å½±å“éå†ã€‚java.util.concurrentåŒ…ä¸‹çš„å®¹å™¨éƒ½æ˜¯å®‰å…¨å¤±è´¥çš„,å¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶å‘ä½¿ç”¨,å¹¶å‘ä¿®æ”¹ã€‚å¸¸è§çš„çš„ä½¿ç”¨fail-safeæ–¹å¼éå†çš„å®¹å™¨æœ‰ConcerrentHashMapå’ŒCopyOnWriteArrayListç­‰ã€‚
```

#### 4ã€fail-fastæ˜¯å•¥ï¼Ÿ

**å¿«é€Ÿå¤±è´¥ï¼ˆfailâ€”fastï¼‰**æ˜¯javaé›†åˆä¸­çš„ä¸€ç§æœºåˆ¶ï¼Œ åœ¨ç”¨è¿­ä»£å™¨éå†ä¸€ä¸ªé›†åˆå¯¹è±¡æ—¶ï¼Œå¦‚æœéå†è¿‡ç¨‹ä¸­å¯¹é›†åˆå¯¹è±¡çš„å†…å®¹è¿›è¡Œäº†ä¿®æ”¹ï¼ˆå¢åŠ ã€åˆ é™¤ã€ä¿®æ”¹ï¼‰ï¼Œåˆ™ä¼šæŠ›å‡ºConcurrent Modification Exceptionã€‚

#### 5ã€ä»–çš„åŸç†æ˜¯å•¥ï¼Ÿ

è¿­ä»£å™¨åœ¨éå†æ—¶ç›´æ¥è®¿é—®é›†åˆä¸­çš„å†…å®¹ï¼Œå¹¶ä¸”åœ¨éå†è¿‡ç¨‹ä¸­ä½¿ç”¨ä¸€ä¸ª modCount å˜é‡ã€‚

é›†åˆåœ¨è¢«éå†æœŸé—´å¦‚æœå†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œå°±ä¼šæ”¹å˜modCountçš„å€¼ã€‚

æ¯å½“è¿­ä»£å™¨ä½¿ç”¨hashNext()/next()éå†ä¸‹ä¸€ä¸ªå…ƒç´ ä¹‹å‰ï¼Œéƒ½ä¼šæ£€æµ‹modCountå˜é‡æ˜¯å¦ä¸ºexpectedmodCountå€¼ï¼Œæ˜¯çš„è¯å°±è¿”å›éå†ï¼›å¦åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œç»ˆæ­¢éå†ã€‚

==å¯ä»¥ç†è§£ä¸ºï¼Œä¸€æ—¦éå†åˆ°åˆ°å…ƒç´ è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†ï¼Œç«‹åˆ»æŠ›å‡ºå¼‚å¸¸==

**Tip**ï¼šè¿™é‡Œå¼‚å¸¸çš„æŠ›å‡ºæ¡ä»¶æ˜¯æ£€æµ‹åˆ° modCountï¼=expectedmodCount è¿™ä¸ªæ¡ä»¶ã€‚å¦‚æœé›†åˆå‘ç”Ÿå˜åŒ–æ—¶ä¿®æ”¹modCountå€¼åˆšå¥½åˆè®¾ç½®ä¸ºäº†expectedmodCountå€¼ï¼Œåˆ™å¼‚å¸¸ä¸ä¼šæŠ›å‡ºã€‚

å› æ­¤ï¼Œä¸èƒ½ä¾èµ–äºè¿™ä¸ªå¼‚å¸¸æ˜¯å¦æŠ›å‡ºè€Œè¿›è¡Œå¹¶å‘æ“ä½œçš„ç¼–ç¨‹ï¼Œè¿™ä¸ªå¼‚å¸¸åªå»ºè®®ç”¨äºæ£€æµ‹å¹¶å‘ä¿®æ”¹çš„bugã€‚

ç»“è®ºï¼š==ä¸èƒ½åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶å‘ä¿®æ”¹==

**Tip**ï¼š**å®‰å…¨å¤±è´¥ï¼ˆfailâ€”safeï¼‰**å¤§å®¶ä¹Ÿå¯ä»¥äº†è§£ä¸‹ï¼Œjava.util.concurrentåŒ…ä¸‹çš„å®¹å™¨éƒ½æ˜¯å®‰å…¨å¤±è´¥ï¼Œå¯ä»¥åœ¨å¤šçº¿ç¨‹ä¸‹å¹¶å‘ä½¿ç”¨ï¼Œå¹¶å‘ä¿®æ”¹ã€‚

ç»“è®ºï¼š==å¯ä»¥é€‰æ‹© fial-safeåœ¨å¤šçº¿ç¨‹ä¸‹å¹¶å‘ä¿®æ”¹==

#### 6ã€ConcurrentHashMap çš„åº•å±‚æ•°æ®ç»“æ„å¦‚ä½•ï¼Œå®ƒçš„å¹¶å‘åº¦ä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜

HashMap åº•å±‚åŸºäº `æ•°ç»„ + é“¾è¡¨` ç»„æˆï¼Œä¸è¿‡åœ¨ jdk1.7 å’Œ jdk1.8ä¸­å…·ä½“å®ç°ç¨æœ‰ä¸åŒ

1.7

<img src="images/image-20210512102316766.png" alt="image-20210512102316766" style="zoom:50%;" />

å¦‚å›¾æ‰€ç¤ºï¼Œæ˜¯åˆ Segment æ•°ç»„ã€HashEntry ç»„æˆï¼Œå’Œ HashMap ä¸€æ ·ï¼Œä»ç„¶æ˜¯ æ•°ç»„åŠ é“¾è¡¨

Segment æ˜¯ ConcurrentHashMap çš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œä¸»è¦çš„ç»„æˆå¦‚ä¸‹ï¼š

```java
static final class Segment<K,V> extends ReentrantLock implements Serializable {

    private static final long serialVersionUID = 2249069246763182397L;

    // å’Œ HashMap ä¸­çš„ HashEntry ä½œç”¨ä¸€æ ·ï¼ŒçœŸæ­£å­˜æ”¾æ•°æ®çš„æ¡¶
    transient volatile HashEntry<K,V>[] table;

    transient int count;
        // è®°å¾—å¿«é€Ÿå¤±è´¥ï¼ˆfailâ€”fastï¼‰ä¹ˆï¼Ÿ
    transient int modCount;
        // å¤§å°
    transient int threshold;
        // è´Ÿè½½å› å­
    final float loadFactor;
}
```

HashEntryè·ŸHashMapå·®ä¸å¤šçš„ï¼Œä½†æ˜¯ä¸åŒç‚¹æ˜¯ï¼Œä»–ä½¿ç”¨volatileå»ä¿®é¥°äº†ä»–çš„æ•°æ®Valueè¿˜æœ‰ä¸‹ä¸€ä¸ªèŠ‚ç‚¹nextã€‚

#### 7ã€volatileçš„ç‰¹æ€§æ˜¯å•¥ï¼Ÿ

- ä¿è¯äº†ä¸åŒçº¿ç¨‹å¯¹è¿™ä¸ªå˜é‡è¿›è¡Œæ“ä½œæ—¶çš„å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå˜é‡çš„å€¼ï¼Œè¿™æ–°å€¼å¯¹å…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯ç«‹å³å¯è§çš„ã€‚ï¼ˆå®ç°**å¯è§æ€§**ï¼‰
- ç¦æ­¢è¿›è¡ŒæŒ‡ä»¤é‡æ’åºã€‚ï¼ˆå®ç°**æœ‰åºæ€§**ï¼‰
- volatile åªèƒ½ä¿è¯å¯¹å•æ¬¡è¯»/å†™çš„åŸå­æ€§ã€‚i++ è¿™ç§æ“ä½œä¸èƒ½ä¿è¯**åŸå­æ€§**ã€‚

#### 8ã€é‚£ä½ èƒ½è¯´è¯´ä»–é«˜å¹¶å‘çš„åŸå› å—ï¼Ÿ

â€‹		åŸç†ä¸Šæ¥è¯´ï¼ŒConcurrentHashMap é‡‡ç”¨äº†åˆ†æ®µé”æŠ€æœ¯ï¼Œå…¶ä¸­ Segmet ç»§æ‰¿äº ReentrantLockã€‚ä¸ä¼šåƒ HashTableé‚£æ ·ä¸ç®¡æ˜¯ put è¿˜æ˜¯ get æ“ä½œéƒ½éœ€è¦åŒæ­¥å¤„ç†ï¼Œç†è®ºä¸Š ConcurrentHashMap æ”¯æŒ CurrentcyLevel ï¼ˆSegemt æ•°ç»„æ•°é‡ï¼‰çš„çº¿ç¨‹å¹¶å‘ã€‚æ¯å½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®ä¸€ä¸ª Segment æ—¶ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ Segmentã€‚å°±è¯´è¯´å¦‚æœå®¹é‡å¤§å°è¿˜æ˜¯16ä»–çš„å¹¶å‘åº¦å°±è¯´16ï¼Œå¯ä»¥åŒæ—¶å…è®¸16ä¸ªçº¿ç¨‹æ“ä½œ16ä¸ªSegemnt è€Œä¸”è¿˜æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

```java
public V put(K key, V value) {
    Segment<K,V> s;
    if (value == null)
        throw new NullPointerException();//è¿™å°±æ˜¯ä¸ºå•¥ä»–ä¸å¯ä»¥put nullå€¼çš„åŸå› 
    int hash = hash(key);
    int j = (hash >>> segmentShift) & segmentMask;
    if ((s = (Segment<K,V>)UNSAFE.getObject          
         (segments, (j << SSHIFT) + SBASE)) == null) 
        s = ensureSegment(j);
    return s.put(key, hash, value, false);
}
```

ä»–å…ˆå®šä½åˆ°Segmentï¼Œç„¶åå†è¿›è¡Œputæ“ä½œã€‚

æˆ‘ä»¬çœ‹çœ‹ä»–çš„putæºä»£ç ï¼Œä½ å°±çŸ¥é“ä»–æ˜¯æ€ä¹ˆåšåˆ°çº¿ç¨‹å®‰å…¨çš„äº†ï¼Œå…³é”®å¥å­æˆ‘æ³¨é‡Šäº†ã€‚

```java
final V put(K key, int hash, V value, boolean onlyIfAbsent) {
          // å°†å½“å‰ Segment ä¸­çš„ table é€šè¿‡ key çš„ hashcode å®šä½åˆ° HashEntry
            HashEntry<K,V> node = tryLock() ? null :
                scanAndLockForPut(key, hash, value);
            V oldValue;
            try {
                HashEntry<K,V>[] tab = table;
                int index = (tab.length - 1) & hash;
                HashEntry<K,V> first = entryAt(tab, index);
                for (HashEntry<K,V> e = first;;) {
                    if (e != null) {
                        K k;
 // éå†è¯¥ HashEntryï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™åˆ¤æ–­ä¼ å…¥çš„ key å’Œå½“å‰éå†çš„ key æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™è¦†ç›–æ—§çš„ valueã€‚
                        if ((k = e.key) == key ||
                            (e.hash == hash && key.equals(k))) {
                            oldValue = e.value;
                            if (!onlyIfAbsent) {
                                e.value = value;
                                ++modCount;
                            }
                            break;
                        }
                        e = e.next;
                    }
                    else {
                 // ä¸ä¸ºç©ºåˆ™éœ€è¦æ–°å»ºä¸€ä¸ª HashEntry å¹¶åŠ å…¥åˆ° Segment ä¸­ï¼ŒåŒæ—¶ä¼šå…ˆåˆ¤æ–­æ˜¯å¦éœ€è¦æ‰©å®¹ã€‚
                        if (node != null)
                            node.setNext(first);
                        else
                            node = new HashEntry<K,V>(hash, key, value, first);
                        int c = count + 1;
                        if (c > threshold && tab.length < MAXIMUM_CAPACITY)
                            rehash(node);
                        else
                            setEntryAt(tab, index, node);
                        ++modCount;
                        count = c;
                        oldValue = null;
                        break;
                    }
                }
            } finally {
               //é‡Šæ”¾é”
                unlock();
            }
            return oldValue;
        }
```

é¦–å…ˆç¬¬ä¸€æ­¥çš„æ—¶å€™ä¼šå°è¯•è·å–é”ï¼Œå¦‚æœè·å–å¤±è´¥è‚¯å®šå°±æœ‰å…¶ä»–çº¿ç¨‹å­˜åœ¨ç«äº‰ï¼Œåˆ™åˆ©ç”¨ `scanAndLockForPut()` è‡ªæ—‹è·å–é”ã€‚

1. å°è¯•è‡ªæ—‹è·å–é”ã€‚
2. å¦‚æœé‡è¯•çš„æ¬¡æ•°è¾¾åˆ°äº† `MAX_SCAN_RETRIES` åˆ™æ”¹ä¸ºé˜»å¡é”è·å–ï¼Œä¿è¯èƒ½è·å–æˆåŠŸã€‚

#### 9ã€getï¼Ÿ

â€‹		å°†keyé€šè¿‡Hashå®šä½åˆ°å…·ä½“çš„ Segmentï¼Œå†é€šè¿‡ Hash å®šä½åˆ°å…·ä½“çš„å…ƒç´ ï¼Œå› ä¸º HashEntry ä¸­çš„ value å±æ€§æ˜¯ç”¨ volatile å…³é”®è¯ä¿®é¥°çš„ï¼Œæ‰€ä»¥æ¯æ¬¡è·å–çš„éƒ½æ˜¯æœ€æ–°çš„å€¼ï¼Œ==æ•´ä¸ªè¿‡ç¨‹ä¸åŠ é”==

#### 10ã€1.7è™½ç„¶æ”¯æŒSegmentä½†æ˜¯...

â€‹		å› ä¸º 1.7 æ˜¯é“¾è¡¨ï¼Œæˆ‘ä»¬åœ¨æŸ¥è¯¢çš„æ—¶å€™ï¼Œè¿˜æ˜¯éœ€è¦å»éå†å…¨è¡¨

#### 11ã€1.8æ˜¯å¦‚ä½•å‘¢

â€‹		æŠ›å¼ƒäº†åŸæœ‰çš„ Segment åˆ†æ®µé”ï¼Œé‡‡ç”¨äº† CAS + synchronized æ¥ä¿è¯å¹¶å‘å®‰å…¨è¡Œï¼Œå’Œ HashMap å¾ˆæƒ³ï¼ŒæŠŠä¹‹å‰ HashEntry æ”¹æˆäº† Node ï¼Œä½†æ˜¯ä½œç”¨ä¸å˜ï¼ŒæŠŠå€¼å’Œ next é‡‡ç”¨ volatile å»ä¿®é¥°ï¼Œä¿è¯äº†å¯è§æ€§ï¼Œå¹¶ä¸”ä¹Ÿå¼•å…¥äº† çº¢é»‘æ ‘ï¼Œåœ¨é“¾è¡¨å¤§äºä¸€å®šå€¼çš„æ—¶å€™ä¼šè½¬æ¢ï¼ˆé»˜è®¤æƒ…å†µæ˜¯8ï¼‰

#### 12ã€ConcurrentHashMap æ˜¯å¦‚ä½•å­˜å–çš„ï¼Ÿä»¥åŠæ€ä¹ˆä¿è¯çº¿ç¨‹å®‰å…¨

1. æ ¹æ®keyè®¡ç®—å‡º hascode
2. åˆ¤æ–­å½“å‰æ˜¯å¦éœ€è¦è¿›è¡Œ resize
3. æ—¢ä¸ºå½“å‰ key å®šä½å‡º Nodeï¼Œå¦‚æœä¸ºç©ºè¡¨ç¤ºå½“å‰ä½ç½®å¯ä»¥å†™å…¥æ•°æ®ï¼Œåˆ©ç”¨CASå°è¯•å†™å…¥ï¼Œå¤±è´¥åˆ™è‡ªæ—‹ä¿è¯æˆåŠŸ
4. å¦‚æœå½“å‰ä½ç½®çš„ `hashcode == MOVED == -1`,åˆ™éœ€è¦è¿›è¡Œæ‰©å®¹ã€‚
5. å¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œåˆ™åˆ©ç”¨ synchnoized é”å†™å…¥æ•°æ®
6. å¦‚æœæ•°é‡å¤§äº `TREEIFY_THRESHOLD` åˆ™è¦è½¬æ¢ä¸ºçº¢é»‘æ ‘ã€‚

![image-20210517173828670](images/image-20210517173828670.png)

#### 13ã€ä»€ä¹ˆæ˜¯ CASï¼Ÿ

â€‹		CAS æ˜¯ä¸€ç§ä¹è§‚é”çš„å®ç°æ–¹å¼ï¼Œæ˜¯ä¸€ç§è½»é‡çº§é”ï¼ŒJUC ä¸­æœ‰å¾ˆå¤šå·¥å…·ç±»å°±æ˜¯åŸºäºCASçš„ï¼Œä¹è§‚çš„è®¤ä¸ºä¸ä¼šå‡ºç°å¹¶å‘æ“ä½œæƒ…å†µï¼Œå¦‚æœå‘ç”Ÿäº†ï¼Œè¿”å›ä¸ªé”™è¯¯å°±å¥½äº†ã€‚å¾ˆä¹è§‚

#### 14ã€CAS å°±ä¸€å®šèƒ½ä¿è¯æ•°æ®æ²¡æœ‰è¢«åˆ«çš„çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Ÿ

â€‹		å¹¶ä¸æ˜¯ï¼Œæ¯”å¦‚ ABA é—®é¢˜ï¼ŒCAS å°±å¾ˆæ— å¥ˆï¼ï¼

#### 15ã€ä»€ä¹ˆæ˜¯ABA

â€‹		æ¯”å¦‚å­˜é’±ç½é‡Œæœ‰ 10å—é’±ï¼Œå½“CASæ¥çœ‹ä»–æ—¶ï¼Œå‘ç°ä»–æœ‰10å—ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæœ‰ä¸¤ä¸ªäººï¼Œä¸€ä¸ªäººæ‹¿èµ°äº†5å—ï¼Œå¦ä¸€ä¸ªäººåˆæ”¾å›å»äº†5å—ã€‚è¿™ä¸ªæ—¶å€™ï¼Œé’±è¿˜æ˜¯æ²¡å˜ã€‚CASä¸€ç…ï¼Œ10å—é’±æ²¡å˜ï¼çœ‹æ¥æ²¡äººåŠ¨è¿‡ä»–ï¼Œæˆ‘CASå°±å¯ä»¥ç»§ç»­æ“ä½œäº†ã€‚ä½†æ˜¯ä»–å¹¶ä¸çŸ¥é“ä¸­é—´æœ‰äººæ“ä½œäº†.. ä¸­é—´é‚£ä¸ªäººå°±æ˜¯B ï¼ŒCAS å°±å¥½æ¯”æ˜¯A è¿™å°±æ˜¯ ABAé—®é¢˜

#### 16ã€æ€ä¹ˆè§£å†³ABAé—®é¢˜

â€‹		åŠ ä¸ªç‰ˆæœ¬å°±å¥½äº†ï¼Œæ”¹æˆåŠŸäº†ï¼Œå°±ç»™ä»–+1ï¼Œè¿˜æœ‰æ—¶é—´æˆ³ä»€ä¹ˆçš„ï¼Œä¸€èµ·æŸ¥å‡ºæ¥ï¼Œå¯¹çš„ä¸Šæ‰ä¿®æ”¹ï¼Œå¹¶ä¸”ä¿å­˜çš„æ—¶å€™è¿åŒæ–°çš„æ—¶é—´æˆ³ä¹Ÿä¸€èµ·ä¿å­˜äº†ã€‚å’Œç‰ˆæœ¬å·å¼‚æ›²åŒå·¥ä¹‹å¦™

#### 17ã€CASæ€§èƒ½å¾ˆé«˜ï¼Œä½†æ˜¯synchroniedæ€§èƒ½ä¸è¡Œï¼Œä¸ºå•¥1.8ä¹‹ååè€Œ synchronied æ›´å¼ºäº†ï¼Ÿ

â€‹		synchronied ä¹‹å‰ä¸€ç›´æ˜¯é‡é‡é”ï¼Œä½†æ˜¯ java å®˜æ–¹åæ¥å¯¹ä»–å‡çº§äº†ï¼Œé‡‡ç”¨é”å‡çº§çš„å½¢å¼ï¼Œé’ˆå¯¹ synchronied è·å–é”çš„æ–¹å¼ï¼ŒJVM ä½¿ç”¨äº†é”å‡çº§çš„ä¼˜åŒ–æ–¹å¼ï¼Œå°±æ˜¯å…ˆä½¿ç”¨åå‘é” ä¼˜å…ˆåŒä¸€çº¿ç¨‹ç„¶åå†æ­¤è·å–é”ï¼Œï¼Œå¦‚æœå¤±è´¥äº†å°±å‡çº§ä¸º CAS è½»é‡çº§é”ï¼Œå¦‚æœå†å¤±è´¥å°±ä¼šçŸ­æš‚è‡ªæ—‹ï¼Œæ”¾ç€çº¿ç¨‹è¢«ç³»ç»ŸæŒ‚èµ·ï¼Œå¦‚æœæœ€åéƒ½å¤±è´¥äº†å°±å‡çº§ä¸º é‡é‡çº§é”

#### 18ã€ConcurrentHashMap çš„getï¼Ÿ

1. æ ¹æ®è®¡ç®—å‡ºæ¥çš„ hashcode å¯»å€ï¼Œå¦‚æœåœ¨é€šä¸Šï¼Œç›´æ¥è¿”å›
2. å¦‚æœæ˜¯çº¢é»‘æ ‘å°±æŒ‰çº¢é»‘æ ‘å»æ‹¿
3. ä¸æ»¡è¶³å°±ä¸€ä¸ªä¸€ä¸ªéå†æŒ‰é“¾è¡¨æ‰¾

1.8 åœ¨ 1.7 çš„æ•°æ®ç»“æ„ä¸Šåšäº†å¤§çš„æ”¹åŠ¨ï¼Œé‡‡ç”¨çº¢é»‘æ ‘ä¹‹åå¯ä»¥ä¿è¯æŸ¥è¯¢æ•ˆç‡ï¼ˆ`O(logn)`ï¼‰ï¼Œç”šè‡³å–æ¶ˆäº† ReentrantLock æ”¹ä¸ºäº† synchronizedï¼Œè¿™æ ·å¯ä»¥çœ‹å‡ºåœ¨æ–°ç‰ˆçš„ JDK ä¸­å¯¹ synchronized ä¼˜åŒ–æ˜¯å¾ˆåˆ°ä½çš„ã€‚