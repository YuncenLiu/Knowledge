## Oracle ä½¿ç”¨loopã€cursor æŸ¥è¯¢æ‰€æœ‰è¡¨æ€»è¡Œæ•°

[toc]

> å¯¹äºåˆšæ¥è§¦æ•°æ®åº“çš„å°ä¼™ä¼´ä»¬æ¥è¯´ï¼ŒSQLè¯­å¥åªæ˜¯æ–¹ä¾¿æˆ‘ä»¬æŸ¥è¯¢çš„å·¥å…·ï¼Œä½†æ˜¯ä¼´éšç€æˆ‘ä»¬æ—¥ç²¾æœˆç›Šçš„å¼€å‘ã€‚ç®€å•çš„æŸ¥è¯¢å·²ç»ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„å¼€å‘éœ€æ±‚ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åˆ°SQLè¿›è¡Œç¼–ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹ï¼Œæˆ‘ä»¬ç§°ä¹‹ï¼šSQLç¼–ç¨‹

### 1ã€ç®€å•å®ç°å¾ªç¯

```sql
-- Auth Xiangæƒ³
declare 
  i number:=0;          						-- å®šä¹‰å˜é‡ i numberç±»å‹ï¼Œå¹¶ä¸”èµ‹å€¼ 0
begin
  loop                  						-- å¼€å¯å¾ªç¯
     i:=i+1;            						-- è‡ªå¢ 
     if i>10 then       						-- if åˆ¤æ–­ å½“ i>10 æ—¶
        exit;           						--              é€€å‡ºå¾ªç¯
     end if;            						--         if ä¸º é
     dbms_output.put_line(i);                   -- è¾“å‡º   
  end loop;             						-- ç»“æŸå¾ªç¯
  dbms_output.put_line('æœ€åï¼š'||i);             -- è¾“å‡º      
end;
```

è¾“å‡ºç»“æœï¼š

![image-20201110192243324](images/1.png)

### 2ã€ç®€å•å®ç°æ¸¸æ ‡

```
DECLARE
  -- æŠŠ emp è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œå…¨éƒ¨æ”¾è¿›æ¸¸æ ‡ä¸­
  cursor c is select * from all_users;
  u all_users%rowtype;
BEGIN 
  open c;
    loop
      fetch c into u;
      exit when c%notfound;
      dbms_output.put_line(u.username||'---'||u.user_id);
    end loop;
  close c;
END;
```

æˆ‘ä»¬å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œ==c==  æ˜¯ä¸€ä¸ªList<Map>ç±»å‹çš„é›†åˆï¼Œä»–æŠŠæ•´ä¸ª all_users è¡¨éƒ½è£…è¿›å»äº†

å…¶æ¬¡ï¼Œæˆ‘ä»¬å®šä¹‰äº†  ==u==  æ˜¯List<Map> ä¸­ä¼—å¤šMapä¸­çš„ä¸€ä¸ªï¼Œ ç±»å‹ä¸º all_users ç±»å‹

ç„¶å æˆ‘ä»¬æ‰“å¼€æ¸¸æ ‡ c ï¼Œè¿›è¡Œå¾ªç¯

å› ä¸ºæ˜¯å¾ªç¯éå†ä¸€ä¸ª List<Map> æˆ‘ä»¬æ¯éå†å‡ºæ¥çš„ä¸€ä¸ªMapéƒ½å°†æ”¾è¿› ==u== ä¸­ï¼Œä¹Ÿç¬¦åˆ all_users ç±»å‹  ã€all_users%rowtypeã€‘

å½“æ¸¸æ ‡ ==c== å¾ªç¯éå†åˆ°æ‰¾ä¸åˆ°çš„æ—¶å€™ï¼Œé€€å‡º ã€exitã€‘

æœ€åï¼Œæˆ‘ä»¬è¾“å‡ºè¿™ä¸ªMapä¸­çš„å€¼ï¼Œ u.username    u.user_id

é€€å‡ºå¾ªç¯ã€å…³é—­æ¸¸æ ‡ã€é€€å‡º

![image-20201110195208280](images/2.png)

> å½“æˆ‘ä»¬ç†è§£Loop å’Œ æ¸¸æ ‡ä¹‹åï¼Œå°±æƒ³æ˜¯ç†è§£äº† å¾ªç¯ å’Œ å®¹å™¨ï¼Œæœ‰äº†å®¹å™¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¹²ä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„äº‹æƒ…äº†ï¼Œå°±æ¯”å¦‚ï¼ŒæŠŠæ•°æ®åº“ä¸­æ‰€æœ‰çš„è¡¨çš„æ•°æ®æ¡æ•°è¾“å‡ºå‡ºæ¥

### 3ã€é€šè¿‡ loopã€cursor æŸ¥å‡ºæ•°æ®åº“ä¸­æ‰€æœ‰è¡¨çš„æ€»æ¡æ•°

==å‰ææ˜¯æˆ‘ä»¬æ“ä½œæ•°æ®åº“çš„æƒé™å¿…é¡»æ˜¯dba==

æˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥è¯¢ user_tables è§†å›¾ï¼Œè·å–åˆ°æ•°æ®åº“çš„æ‰€æœ‰è¡¨

```sql
select table_name from user_tables;
```

ç°åœ¨å¯ä»¥æŸ¥è¯¢åˆ°æ‰€æœ‰çš„è¡¨åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿›è¡Œéå†è¿™ä¸ªè¡¨åäº†

```sql
-- Auth Xiangæƒ³
DECLARE
  -- æŠŠ user_tables è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œå…¨éƒ¨æ”¾è¿›æ¸¸æ ‡ä¸­
  cursor c1 is select table_name from user_tables;
  v_tabNm varchar2(100);
BEGIN
  open c1;
    loop
      exit when c1%notfound;
      fetch c1 into v_tabNm;
      DBMS_Output.put_line(v_tabNm);
    end loop;
  close c1;
END;
```

ç”¨ v_tabNm æ¥è·å–è¡¨åï¼Œå¹¶æ‰“å°å‡ºæ¥

å¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬æœ€ç»ˆçš„ç›®çš„å¹¶ä¸æ˜¯æ‰“å°å‡ºæ¥ï¼Œè€Œæ˜¯åˆ©ç”¨è·å–åˆ°çš„è¡¨åæ‹¼æ¥å¤„æŸ¥è¯¢è¯­å¥  ä¾‹å¦‚ï¼š  select count(0) from [è¡¨å]

æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥åŠ ä¸¤ä¸ªå˜é‡ï¼Œ 

+ v_num  numberç±»å‹ï¼Œç”¨æ¥è·å–æŸ¥è¯¢å‡ºæ•°æ®çš„æ€»é‡
+ v_sql     varhcar2ç±»å‹ï¼Œç”¨æ¥æ‹¼æ¥sqlä½¿ç”¨

å†åˆ©ç”¨ ==EXECUTE IMMEDIATE== å…³é”®å­—ï¼Œæ‰§è¡Œæˆ‘ä»¬æ‹¼æ¥å¤„çš„sqlè¯­å¥ï¼ŒæŠŠå€¼è¿”å›åˆ° v_num ä¸­å®ç°ï¼ŒæŸ¥è¯¢å‡ºè¡¨çš„æ€»è¡Œæ•°

```sql
-- Auth Xiangæƒ³
DECLARE
  -- æŠŠ user_tables è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®ï¼Œå…¨éƒ¨æ”¾è¿›æ¸¸æ ‡ä¸­
  cursor c1 is select table_name from user_tables;
  v_tabNm varchar2(100);                          -- è¡¨å
  v_sql varchar2(200);                            -- sqlè¯­å¥   
  v_num NUMBER(10);                               -- æŸ¥åˆ°çš„æ€»æ¡æ•°
BEGIN
  open c1;
    loop
      exit when c1%notfound;
      fetch c1 into v_tabNm;
      v_sql:='select count(*) from '||v_tabNm;
      EXECUTE IMMEDIATE v_sql INTO v_num;
      DBMS_Output.put_line(v_tabNm||'è¡¨ä¸­æœ‰ï¼š'||v_num||'è¡Œæ•°æ®');
    end loop;
  close c1;
END;
```

ç»“æœ:

![image-20201110201238961](images/image-20201110201238961.png)

å¿«å»è¯•è¯•å§ï¼

><center><b><font color=blue >å¥½äº†åˆ°è¿™æˆ‘ä»¬çš„åˆ†äº«ä¹Ÿå°±ç»“æŸäº†ğŸ˜‰</font></b></center>
>
><center><b><font color=blue >å¸Œæœ›ä»¥ä¸Šæ–¹æ³•å¯ä»¥å¸®åˆ°æ‚¨ï¼Œç¥æ‚¨å·¥ä½œæ„‰å¿«ï¼ğŸ’–</font></b></center>
>
><center>ğŸ‘‡</center>
><center><b><font color=pink >å¯¹æ‚¨æœ‰å¸®åŠ©çš„è¯è®°ç‚¹èµå¾—æ”¶è—å“¦ï¼ğŸ‘</font></b></center>
><center><font color=blue>æˆ‘æ˜¯</font>       <font color=red>Xiangæƒ³</font>     <font color=blue>ä»ä¸€ä¸ªå°ç™½ä¸€æ­¥ä¸€æ­¥åœ°å˜æˆå·¥å…·äºº ğŸ˜›</font></center>

